name: Release Migrations

on:
  push:
    branches:
      - develop
      - pcnc/fix-migrations-workflow

permissions:
  id-token: write

jobs:
  build:
    runs-on: [self-hosted, linux]
    timeout-minutes: 15

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: Merging migration files
        run: cat $(ls -1) > ../migration-output.sql
        working-directory: ${{ github.workspace }}/migrations/db/migrations


      - name: configure aws credentials - staging
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.DEV_AWS_ROLE }}
          aws-region: "us-east-1"

      - name: Push migration files to S3 - staging
        run: |
          aws s3 sync ./migrations/db s3://${{ secrets.PG_INIT_SCRIPT_S3_BUCKET_STAGING }}/migrations-test/db --region ap-southeast-1

      # - name: configure aws credentials - prod
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     role-to-assume: ${{ secrets.PROD_AWS_ROLE }}
      #     aws-region: "us-east-1"

      # - name: Push migration files to S3 - prod
      #   run: |
      #     aws s3 sync ./migrations/db s3://${{ secrets.PG_INIT_SCRIPT_S3_BUCKET_PROD }}/migrations-test/db --region ap-southeast-1

